<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- axios 로 form 태그 대신 전송 받아오기 ⭐⭐ -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>


</head>

<style>


    #post_01 {
        background-color: lightgray;
        width: 300px;
        height: 300px;
    }
/* 
    #page_navigation { 
        width: 600px;
        height: 200px;
        background-color: lightblue;
    } */

    .post_container {
        background-color: lightgreen;
        width: 300px;
        height: 500px;
        display: inline-block;
        margin: 10px;
    }


    .post_image {
        width: 100%;
    }


</style>



<body>

    <h1>게시판 목록</h1>
    <p>중요정보 카드 식으로 요약해서 보여주면 됨</p>
    <p>hover 기능으로 제목 보여주는 건 시간 되면</p>

    <div id="page_navigation">

        <!-- <h3>
            <a href="http:127.0.0.1:4000/board/list/:page"> 1page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 2page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 3page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 4page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 5page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 6page </a>
            <a href="http:127.0.0.1:4000/board/list/:page"> 7page </a>
        </h3> -->

    </div>


<div id="posts_wrapper">

        <!-- 아이템 1 -->
        <div id="post_01">
            
            <div> 
                제목 : <span id="postTitle_container">  </span>
            </div>

            <div> 
                댓글 수 : <span id="commentCount_container">   </span>
            </div>

            <div> 
                글쓴이 : <span id="writer_container">  </span>
            </div>
            
            <div>
                유저 프로필 이미지 : <span id="writer_profileImg">  </span>
            </div>

            <div> 
                작성일자 : <span id="createDate_container">  </span>
            </div>

            <div>
                유저 경험치 :  <span id="userExp_container"> </span>
            </div>

            <div>
                views : <span id="postViews_container"> </span>
            </div>

            <div>
                likes 숫자 : <span id="likes_number"> </span>
            </div>

            <div>
                🧡 likes 버튼 <span id="likes_likesBtn"></span>
            </div>

            <div>
                올린 사진 : <span id="postImg_container">  </span>
            </div>

        </div>

</div>





    
</body>


<script>
// 🔹 전역변수 

    // 사용자가 클릭한 게시글의 POST ID
    userClickPostID = 0;
        // [설명] 
            // '게시글 목록' 중, 사용자가 특정 게시글을 '클릭' 하면, 
            // 해당 게시물의 'POST ID' 를 
            // addeventListner 의 event target.id 사용해서 가져오고 
            // 이걸 GET 요청에 넣기? 

    // 그려지기 전 준비된 배열통 | 이걸로 그려나감
    arrPostWithCommentUser = [];


// getView 함수 
    async function getView(arrPostWithCommentUser , page_num=1) {

        try {

            // 1. 필요한 데이터 가져오기 

                // 1) 넘길 데이터 준비 
                    // 뭘 넘겨야 하지? 
                    // 페이지네이션 하려면? 음😥😥😥 

                    // a) '몇 번째 페이지 클릭' 했는지 (사용자 클릭가능 한 것 관점)
                        // [효과] 이걸 클릭하면 -> 해당 페이지네이션이 보여져야 함
                        // [생각해보기]
                            // '첫 메인 페이지' 는 어떤 페이지가 클릭되었는지, 필요 없음. 
                            // '2번째 페이지' 로 갈 때, 2번째 페이지의 post, user 테이블 다 가져와야 함
                            // 그럼, 어떤 페이지를 클릭했는지 어떻게 가져올거야? 
                                // eventListener 달아줘서, 클릭되면, get 요청 해서 -> 그 페이지 보여 달라⭐⭐
                            
                            // 이 페이지는 postListPage 라고 할 수 있겠다

                    // b) '어떤 게시글 클릭' 했는지 (사용자 클릭가능 한 것 관점)
                        // [효과] 이걸 클릭하면 -> 해당 게시글이 보여져야 함
                        // [생각해보기]
                            // 어떤 게시글이 클릭되었나? 
                            // 특정 상세 페이지로 넘어가려면, 뭐가 필요하지? 
                                // post 의 id 값이 필요해 ⭐ 
                            // '사용자가 그 post id 를 클릭했다.' 라는 데이터를 어떻게 얻지? ⭐⭐⭐
                                // 댓글을 생각해보면, ⭐⭐⭐⭐⭐⭐⭐⭐  
                                    // for 문으로 '댓글 tag 가 생성' 될 때, '댓글 tag id' 에 'comment ID' 를 묻혀셔 -> split 해서 추출하지 않았나? 
                            // 그러면, ✅ '사용자가 이 post id 를 클릭했다' (userClickPostID) 라는 전역변수, 를 가지고 -> GET 요청을 하게 된다. 

                    // C) 그럼 구체적으로 어떤 GET 요청
                        // 


                // 2) 넘기기
                    // a) 언제 요청? ⭐⭐
                        // 이 페이지가 로드되면 요청되어야 함 -> so, DOMContentLoaded 이벤트가 발생하면, getView 실행 


                    // b-1) 새롭게 시도 | 여기에 아예, 페이지네이션 시작하기 | 기본 디폴트로 1 시작하기
                        // const page_num = 1    // 기본값을 우선 1로 하려고 ✅ | 여기를 매개변수화 ✅                 
                    const {data} = await axios.get(`http://127.0.0.1:4000/board/list/page?num=${page_num}` , {
                        withCredentials : true,
                    })

                    console.log("@boardList > getView() 들어오는거 확인 🙆‍♂️ " , data)



                        // // b) 요청하기 [예전버전]
                        // const {data} = await axios.get("http://127.0.0.1:4000/board/list" , {
                        //             withCredentials : true,
                        //             });
                                    
                        //         // 데이터 첨부하는 버전
                        //             // const {data} = await axios.get(`http://127.0.0.1:4000/board/list` , {
                        //             //             withCredentials : true,
                        //             //             params : {
                        //             //                 id : postId,     
                        //             //             }});
                                
                // 3) 잘 들어왔는지 확인        
                    
                    // console.log("@boardList > getView() 들어오는거 확인 🙆‍♂️ " , data)
                    
                    // // a) login한 user 확인  
                    //     // loginUserData = data.loginUser
                    //         console.log("현재 로그인한 유저 데이터" , loginUserData)


                    // // b) post 테이블에서 필요한 데이터 확인 
                    //     // 제목
                            console.log("제목" , data.data[0].title)       // 첫번째 글 
                        
                    //     // 글쓴이 
                    //         // 이 게시글의 user_id 를 가져온다. 
                            console.log("글쓴이" , data.data[0].user_id)     // dj
                            
                    //     // 작성일자
                            // console.log(data.data[0].createdAt)       // 2023-06-15T05:51:56.000Z
                            console.log("작성일자" , data.data[0].createdAt.split('T')[0])       // 2023-06-15
                            
                    //     // views 
                            console.log("view" , data.data[0].views)       // 1
                            
                    //     // likes 숫자 
                            console.log("likes" , data.data[0].likes)       // 16

                    // // c) user 테이블에서 필요한 데이터 
                    //     // 유저 프로필 이미지 
                    //         // profile_img 속성에서 가져오면 됨
                            console.log("프로필이미지" , data.data[0].User.profile_img)       // http://127.0.0.1:4000/monami.png

                    //     // 유저 경험치 
                            console.log("유저경험치" , data.data[0].User.exp)        // 0
                            
                    
                    // // d) comment 테이블에서 필요한 데이터 
                    //     // 댓글수
                            console.log("댓글수" , data.data[0].Comments.length)     // 51        // 0
                
                
            // 3-1) 보내줄 데이터 확인 ✅✅ 
                // 1)) post 테이블에 보낼 데이터 
                    // likes 버튼 클릭 -> likes 올라가게 하기 
                    
                // 2) 해당 게시글 누르면 -> views 올라가게 하기 


                // CF. 고민 
                    // 전체 배열통 만들기 == sequelize 에서 include 로 해오기 
                    // | 그려줘야 하는 것 '게시글당 모아주기' 👉 이걸 외래키를 쓰면, sequelize 에서 해줌 ⭐⭐⭐
                    
                            // a) 데이터 형태 
                                // ex) [ {1번게시물} , {2번게시물}, {3번 게시물} ]
                            // b) 이곳에서 뭘 할 수 있나? 
                                // 전체통을 '이름순' 으로 정렬하면 -> 게시글 조회 이름순이 된다.
                                // 전체통을 'exp순' 으로 하면 -> 랭킹순으로 된다. 
                                // 전체통을 '좋아요' 순으로 하면 -> 좋아요 순으로, 처음보여질 때, 보여진다.
                                // 우선, 230616 현재, 기본 정렬된걸로, 그려주기 

                            // c) 사용할 수 있는 기능               
                                // map? fileter? 

                // CF. 현 시점에서 할일 정리 ✅✅✅
                    // USER 테이블의 ID 를 기준으로 하나로 묶을까? ⭐⭐⭐⭐⭐⭐⭐ 
                        // 1) post 데이터를 POST ID 순서로 정렬해 ⭐⭐⭐⭐⭐ | 여기에서 '게시판 정렬이 들어감'
                        // 2) 해당 POST ID 를 적은 USER ID 를 찾아 
                        // 3) 그 USER ID 와 관련된 COMMENT 테이블, USER 정보를 가져와서 -> ⭐하나의 객체⭐로 만든다. ⭐⭐⭐⭐⭐ 
                        // 4) 그래서 '전체 게시글 배열'= [ {첫번째 보여주면 되는 게시글 관련 정보} , {두 번째 보여주면 되는 게시글 관련 정보}, 등등 ] 으로 나열해
                        // 5) 그 다음, '전체 게시글 배열'을 페이지 별로 잘라서, 다시 배열에 넣는다. 
                            // ex) '페이지 구분된 전체 게시글'= [ [첫번째 페이지] , [두 번째 페이지] , ...   ]
                        // 6) 그 다음, 첫 번째 페이지를 클릭하면 -> '페이지 구분된 전체 게시글'[0] 이 될 수 있게 한다. 


            // 4) '배열통 확정' | ✅ 이 부분에서 '좋아요 순, 조회수 순, 등으로 변경 가능'
                // 👉 이건 이제 sequelize - include 에서 해왔음 ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐
                const arrPostWithCommentUser = data.data
                console.log("배열통확인" , arrPostWithCommentUser)



            // 5) 주주룩 보이게 하기 
                arrPostWithCommentUser.forEach( (element, index) => {
                    

                    // 게시글 container div 
                        const post_container = document.createElement('div');
                        post_container.classList.add("post_container")      
                        post_container.id = `post_container_${element.id}`      // 해당 게시글 id

                    // 제목 container
                        const title_container = document.createElement('div');
                        title_container.id = `title_container_${element.id}`
                        title_container.textContent = element.title
                        post_container.appendChild(title_container)
                        
                    // 댓글수 container
                        const comment_num_container = document.createElement('div');
                        comment_num_container.id = `comment_num_${element.id}`
                        comment_num_container.textContent = element.Comments.length
                        post_container.appendChild(comment_num_container)
                        
                    // 글쓴이 container
                        const post_writer_container = document.createElement('div');
                        post_writer_container.id = `post_writer_container_${element.id}`
                        post_writer_container.textContent = element.user_id
                        post_container.appendChild(post_writer_container)
                        
                    // 유저 프로필 이미지 container | 📛 사진이 없음. 
                        // 사진이 들어갈 수 있는 div
                        const user_profileImg_container = document.createElement('div');
                        user_profileImg_container.id = `profileImg_container_${element.id}`

                        // div 안에 img 태그로 사진 넣기
                        const profileImg_Img = document.createElement('img');
                        profileImg_Img.src = element.User.profile_img;    
                            
                        // console.log("사진 경로 확인🚀", element.User.profile_img)

                        post_container.appendChild(user_profileImg_container)

                    // 작성일자 container 
                        const createdAt_container = document.createElement('div');
                        createdAt_container.id = `createdAt_${element.id}`
                        createdAt_container.textContent = element.createdAt.split('T')[0]
                        post_container.appendChild(createdAt_container)
                        
                    // 유저 경험치 container 
                        const exp_container = document.createElement('div');
                        exp_container.id = `exp_${element.id}`
                        exp_container.textContent = element.User.exp
                        post_container.appendChild(exp_container)
                        
                    // views container 
                        const views_container = document.createElement('div');
                        views_container.id = `exp_${element.id}`
                        views_container.textContent = element.views
                        post_container.appendChild(views_container)
                        
                    // likes container 
                        const likes_container = document.createElement('div');
                        likes_container.id = `likes_${element.id}`
                        likes_container.textContent = element.likes
                        post_container.appendChild(likes_container)
                        
                    // likes 버튼 container 
                        const likesBtn_container = document.createElement('button');
                        likesBtn_container.id = `likesBtn_${element.id}`
                        likesBtn_container.textContent = "👍좋아요"
                        post_container.appendChild(likesBtn_container)

                    // post 에 유저가 올린 사진 container
                        const post_image_container = document.createElement('div');
                        const post_image = document.createElement('img');
                        post_image.classList.add('post_image');
                        post_image.src = `http://127.0.0.1:5500/Monami/backEnd/image/${element.post_img}`;    

                        // console.log("사진 경로 확인🚀", element.User.profile_img)

                        post_image_container.appendChild(post_image)
                        post_container.appendChild(post_image_container)



                    // 'posts_wrapper' 에,  게시글 하나를 담은 post_container 를 붙이기 
                    posts_wrapper.appendChild(post_container)

                });

                
            // 6) 페이지네이션 보여줄 div 
                pageNavigation(10)
                pageShow()

                // console.log("서버에서 받은 결과 찍어보자" , result)



            // 6) 채워진걸 -> 페이지네이션 별로 나누기 => 이것도 sequelize 에서 
                // a) 16 으로 나눠서 -> 배열이 되게 map 함수를 써야 하나? 
                
                // b) 아, 이것도, sequelize 에서 바로 할 수 있네? ⭐⭐⭐⭐⭐⭐ 
                    
                // html 상 페이지네이션이 들어갈 공간 
                    // const page_navigation = document.createElement('div');
                    

                    // const temp_aTag = document.createElement('a')
                    // temp_aTag.href = `http://127.0.0.1:4000/board/list/:1`
                    // temp_aTag.textContent = `page 1`

                    // page_navigation.appendChild(temp_aTag)
            
            // 8) 사용자가 1을 클릭하면 -> 첫 번째 배열을 렌더통에 넣기
                
                


                    
        } catch (error) {
            console.log(error)
        }
    }



// 🔹 1page, 2page 보여주는 함수 
    let pageNavigation = (page_num) => {

        for(i=1; i<=page_num; i++) {
            page_navigation.innerHTML += `
                <button class="pageNumBtn" id="page_btn_${i}"> ${i}page </button>
                `    
        }
        
    }



// 🔹 view 초기화 시키는 함수 | 이게 없으면 누적되어서 나옴 
    initializedView = async (arrPostWithCommentUser , page_num) => {

        // post 내용들 전부 비우기
            posts_wrapper.innerHTML = ``;

        // page1, page2 .. 버튼 전부 지우기 
            page_navigation.innerHTML = ``;

        await getView(arrPostWithCommentUser , page_num)
    }




    
// 🔹 페이지 클릭하면, 보내는 함수 

let pageShow = () => {
    const pageNumBtns = document.getElementsByClassName('pageNumBtn');

        // [새로운 시도] 보여주는 함수 이제 만들었으니, 그걸 써보기
        Array.from(pageNumBtns).forEach((btn) => {
            btn.onclick = async (event) => {
                const clickedPage = event.target.id.split('_')[2];
                getView(clickedPage)
            }
        })


        // [과거코드]
            // Array.from(pageNumBtns).forEach((btn) => {
            //     btn.onclick = async (event) => {
            //         console.log("🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀")
            //         console.log(event.target.id);
                    
            //         const page_num = event.target.id;
                
            //         await axios.get(`http://127.0.0.1:4000/board/list/page?num=${page_num}`)
            //         .then((response) => {
                        
            //             // 내가 원하는 데이터를 '배열통' 으로 받아오기
            //             console.log(response.data.result);
            //             console.log("🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴🛴")

            //             // '배열통' 을 '매개변수' 로 꽂아주기
            //             arrPostWithCommentUser = response.data.result       // 📛 전역변수 주의

            //             initializedView(arrPostWithCommentUser)
                        
            //         });
            //     }
            // });
}
        // [과거 코드]
            // let pageShow = () => {

            //     document.getElementsByClassName('pageNumBtn').onclick = async (event) => {
                        
            //             console.log("🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀")
            //             console.log(event.target.id)
            //             const i = event.target.id



            //             // get 으로 다시 시도 ⭐⭐ 
            //             await axios.get(`http://127.0.0.1:4000/board/list/page?num=${i}`)
            //             .then((e) => {
            //                 res.sendFile(path.join(__dirname , "./boardList.html"))
            //             })





            //             // 그 다음, 상세 페이지는,then, 에서 getAPI 를 함 여기도 그러면 될까 ?⭐⭐ 


            //             // axios.post(`http://127.0.0.1:4000/board/list/page?num=${i}` , form , {
            //             //     "Content-type" : "json/application"
            //             // }).then((e) => {
            //             //     const redirectURL = e.data.redirectURL; 
            //             //     window.location.href =redirectURL;
            //             // }).catch((err) => {
            //             //     console.log(err)
            //             // })
            //         }
            //         // 여기에 postPerPage 이거를 얼마나 할지 여기서 넘겨줘야 하나? 
            //         // href="http://127.0.0.1:4000/board/list/page?num=${i}"
            // }





// 🔹 getView 실행 

    document.addEventListener('DOMContentLoaded' , async function() {
        
        console.log("getView 실행된건가? 💎")

        // 여기에서 getview 가 아니라, 
            // 1) 초기화된게 실행 되어야 하고 ⭐⭐⭐ 
            // 2) 매개변수를 받아야 한다. ⭐⭐⭐ 
            // 3) 음... 
        await initializedView( arrPostWithCommentUser , 3 );

        

    })



</script>





</html>